define(["jquery","underscore","backbone","HomeView","ProfileView","fullTopicView","ConfirmView","UserModel","TopicModel"],function(e,t,n,r,i,s,o,u,a){function y(){var e=l;v=!0,e.homeView&&e.homeView.remove(function(){e.navigate("loading",d),e.navigate("",p)})}var f,l,c={},h=e("body"),p={trigger:!0},d={replace:!0},v=!1,m=new o,g;return i.setConfirmView(m),s.setConfirmView(m),f=n.Router.extend({routes:{"":"home",connect:"connect",logout:"logout",":screen_name/topic/:_id":"showTopic"},initialize:function(){l=this,g=new u({_id:"current"}),e("#welcome")[0]&&(this.homeView=new r),e("#profile")[0]&&(this.profileView=new i({model:g}));var t=this,n=e("#JSONuser"),s;n[0]?(s=JSON.parse(n.val()),g.set(s),y()):g.fetch({success:y,error:function(e,t,n){v=!0,console.log("ERROR",t)}})},home:function(){var t,n=g.get("user_id");if(!v)return;n?e("#fulltopic")[0]||!~window.location.hash.indexOf("/topic/")?(this.fullTopicView&&this.fullTopicView.remove(),this.profileView=new i({model:g}),this.profileView.render()):(t={user:g.attributes,topics:[]},this.profileView||(delete this.homeView,this.profileView=new i({model:g}),this.profileView.render())):(this.homeView||(this.homeView=new r),this.homeView.render())},connect:function(){if(this.profileView)return this.navigate("",p);var t=this,n=e(window).width()/2-250;window.open("/connect?popup=1","sharer","width=500,height=300,top=150,left= "+n+",personalbar=0,toolbar=0,scrollbars=1,resizable=1"),g.fetch({loop:!0,url:g.url()+"?loop=1",success:function(){t.homeView.remove(function(){t.navigate("",p)})},error:function(e,t,n){console.log("ERROR",t)}})},logout:function(){if(!g.get("user_id"))return this.navigate("",p);var e=this;g.destroy({success:function(){g.attributes={},e.profileView.remove(function(){delete e.profileView,e.navigate("",p)})},error:function(e,t,n){console.log("ERROR",t)}})},showTopic:function(e,t){var n=this,r;g.attributes.user_id||n.navigate("",p),this.profileView&&(r=this.profileView.topics.where({_id:t})[0],r?this.profileView.remove(function(){n.fullTopicView=new s({model:r,topic_id:t,user:g}),n.fullTopicView.render()}):(r=new a({_id:t}),r.fetch({url:"/api/1/"+e+"/topic/"+t,success:function(){n.fullTopicView=new s({model:r,topic_id:t,user:g}),n.fullTopicView.render()},error:function(e,t,n){console.log("ERROR",t)}})))}}),f})