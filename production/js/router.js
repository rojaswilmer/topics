define(["jquery","backbone","HomeView","ProfileView","FullTopicView","ConfirmView","UserModel","TopicModel"],function(e,t,n,r,i,s,o,u){function v(e,t){var n="";t&&(n="?loop=1"),d.fetch({loop:t,url:d.url()+n,success:m,error:function(n,r,i){console.log("ERROR",r),t&&setTimeout(function(){v(e,t)},1e3)}})}function m(){var e=f;h=!0,e.homeView&&e.homeView.remove(function(){e.navigate("loading",c),e.navigate("",l)})}var a,f,l={trigger:!0},c={replace:!0},h=!1,p=new s,d;return r.setConfirmView(p),i.setConfirmView(p),a=t.Router.extend({routes:{"":"home",connect:"connect",logout:"logout",":screen_name/topic/:_id":"showTopic"},initialize:function(){f=this,d=new o({_id:"current"}),e("#welcome")[0]&&(this.homeView=new n),e("#profile")[0]&&(this.profileView=new r({model:d}));var t=e("#JSONuser"),i;t[0]?(i=JSON.parse(t.val()),d.set(i),m()):v(this)},home:function(){var t,i=d.get("user_id");if(!h)return;i?e("#fulltopic")[0]||!~window.location.hash.indexOf("/topic/")?(this.fullTopicView&&this.fullTopicView.remove(),this.profileView=new r({model:d}),this.profileView.render()):(t={user:d.attributes,topics:[]},this.profileView||(delete this.homeView,this.profileView=new r({model:d}),this.profileView.render())):(this.homeView||(this.homeView=new n),this.homeView.render())},connect:function(){if(this.profileView)return this.navigate("",l);var t=this,n=e(window).width()/2-250;window.is_mobile?window.location.href="/connect":(window.open("/connect?popup=1","sharer","width=500,height=300,top=150,left= "+n+",personalbar=0,toolbar=0,scrollbars=1,resizable=1"),v(t,!0))},logout:function(){if(!d.get("user_id"))return this.navigate("",l);var e=this;d.destroy({success:function(){d.attributes={},e.profileView.remove(function(){delete e.profileView,e.navigate("",l)})},error:function(e,t,n){console.log("ERROR",t)}})},showTopic:function(e,t){var n=this,r;d.attributes.user_id||n.navigate("",l),this.profileView&&(r=this.profileView.topics.where({_id:t})[0],r?this.profileView.remove(function(){n.fullTopicView=new i({model:r,topic_id:t,user:d}),n.fullTopicView.render()}):(r=new u({_id:t}),r.fetch({url:"/api/1/"+e+"/topic/"+t,success:function(){n.fullTopicView=new i({model:r,topic_id:t,user:d}),n.fullTopicView.render()},error:function(e,t,n){console.log("ERROR",t)}})))}}),a})